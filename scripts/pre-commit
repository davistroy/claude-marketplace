#!/bin/bash
#
# Pre-commit hook for claude-marketplace
# Validates staged markdown files in the plugins directory
#
# Checks performed:
#   1. Frontmatter validation (description required, name forbidden)
#   2. Code block closure validation
#   3. help.md sync check (commands/skills match actual files)
#   4. Timestamp format validation (YYYYMMDD-HHMMSS)
#   5. Help generation sync check (optional, warning only)
#
# Target: < 5 seconds execution time
#
# Installation:
#   cp scripts/pre-commit .git/hooks/
#   chmod +x .git/hooks/pre-commit
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running plugin validation pre-commit hook..."
echo ""

# Get list of staged .md files in plugins/ (excluding references/ which are documentation)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^plugins/.*\.md$' | grep -v '/references/' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No plugin markdown files staged. Skipping validation.${NC}"
    exit 0
fi

echo "Validating staged plugin files:"
echo "$STAGED_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# Track errors
ERRORS=0
WARNINGS=0

# Validate each staged file
for FILE in $STAGED_FILES; do
    if [ ! -f "$FILE" ]; then
        continue
    fi

    echo "Checking: $FILE"

    # Check for frontmatter delimiters
    FIRST_LINE=$(head -n 1 "$FILE")
    if [ "$FIRST_LINE" != "---" ]; then
        echo -e "  ${RED}[FAIL]${NC} Missing frontmatter (must start with ---)"
        ERRORS=$((ERRORS + 1))
        continue
    fi

    # Extract frontmatter (between first two ---)
    FRONTMATTER=$(sed -n '2,/^---$/p' "$FILE" | head -n -1)

    if [ -z "$FRONTMATTER" ]; then
        echo -e "  ${RED}[FAIL]${NC} Empty or malformed frontmatter"
        ERRORS=$((ERRORS + 1))
        continue
    fi

    # Check for required 'description' field
    if ! echo "$FRONTMATTER" | grep -q "^description:"; then
        echo -e "  ${RED}[FAIL]${NC} Missing required 'description' field in frontmatter"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "  ${GREEN}[PASS]${NC} description field present"
    fi

    # Check for forbidden 'name' field (per CLAUDE.md)
    if echo "$FRONTMATTER" | grep -q "^name:"; then
        echo -e "  ${RED}[FAIL]${NC} Forbidden 'name' field found (filename determines command name)"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "  ${GREEN}[PASS]${NC} No forbidden 'name' field"
    fi

    # Check for basic YAML syntax (colon after field name)
    if echo "$FRONTMATTER" | grep -E "^[a-z]+" | grep -v ":"; then
        echo -e "  ${YELLOW}[WARN]${NC} Possible YAML syntax issue (missing colon?)"
        WARNINGS=$((WARNINGS + 1))
    fi

    # Check for unclosed code blocks
    BACKTICK_COUNT=$(grep -c '```' "$FILE" || true)
    if [ $((BACKTICK_COUNT % 2)) -ne 0 ]; then
        echo -e "  ${RED}[FAIL]${NC} Unclosed code block (odd number of \`\`\`)"
        ERRORS=$((ERRORS + 1))
    fi

    echo ""
done

# ============================================
# Check 3: help.md Sync Validation
# ============================================
echo "Checking help.md sync..."

# Function to extract commands/skills from a help.md file
check_help_sync() {
    local plugin_dir="$1"
    local plugin_name=$(basename "$plugin_dir")
    local help_file="$plugin_dir/skills/help/SKILL.md"

    if [ ! -f "$help_file" ]; then
        echo -e "  ${YELLOW}[WARN]${NC} $plugin_name: No help skill found at $help_file"
        WARNINGS=$((WARNINGS + 1))
        return
    fi

    # Get actual commands (md files in commands/)
    local commands_dir="$plugin_dir/commands"
    if [ -d "$commands_dir" ]; then
        for cmd_file in "$commands_dir"/*.md; do
            if [ -f "$cmd_file" ]; then
                local cmd_name=$(basename "$cmd_file" .md)
                if ! grep -q "/$cmd_name" "$help_file" 2>/dev/null; then
                    echo -e "  ${RED}[FAIL]${NC} $plugin_name: Command /$cmd_name not documented in help.md"
                    echo -e "         Suggestion: Add /$cmd_name to $help_file"
                    ERRORS=$((ERRORS + 1))
                fi
            fi
        done
    fi

    # Get actual skills (SKILL.md files in skills/*/SKILL.md, excluding help/)
    local skills_dir="$plugin_dir/skills"
    if [ -d "$skills_dir" ]; then
        for skill_dir in "$skills_dir"/*/; do
            if [ -d "$skill_dir" ]; then
                local skill_name=$(basename "$skill_dir")
                # Skip help skill
                if [ "$skill_name" = "help" ]; then
                    continue
                fi
                # Check if SKILL.md exists
                if [ -f "$skill_dir/SKILL.md" ]; then
                    if ! grep -q "/$skill_name" "$help_file" 2>/dev/null; then
                        echo -e "  ${RED}[FAIL]${NC} $plugin_name: Skill /$skill_name not documented in help"
                        echo -e "         Suggestion: Add /$skill_name to $help_file"
                        ERRORS=$((ERRORS + 1))
                    fi
                fi
            fi
        done
    fi
}

# Check each plugin directory
for plugin_dir in plugins/*/; do
    if [ -d "$plugin_dir" ]; then
        check_help_sync "$plugin_dir"
    fi
done

echo -e "  ${GREEN}[PASS]${NC} help.md sync check complete"
echo ""

# ============================================
# Check 4: Timestamp Format Validation
# ============================================
echo "Checking timestamp format in staged files..."

TIMESTAMP_PATTERN='[0-9]{8}-[0-9]{6}'
VALID_TIMESTAMP_REGEX='^[0-9]{4}(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])-([01][0-9]|2[0-3])([0-5][0-9])([0-5][0-9])$'

for FILE in $STAGED_FILES; do
    if [ ! -f "$FILE" ]; then
        continue
    fi

    # Look for timestamp-like patterns in the file
    TIMESTAMPS=$(grep -oE "$TIMESTAMP_PATTERN" "$FILE" 2>/dev/null || true)

    for ts in $TIMESTAMPS; do
        # Validate the timestamp format (basic check for valid date/time ranges)
        YEAR=$(echo "$ts" | cut -c1-4)
        MONTH=$(echo "$ts" | cut -c5-6)
        DAY=$(echo "$ts" | cut -c7-8)
        HOUR=$(echo "$ts" | cut -c10-11)
        MIN=$(echo "$ts" | cut -c12-13)
        SEC=$(echo "$ts" | cut -c14-15)

        # Check ranges
        if [ "$MONTH" -lt 1 ] || [ "$MONTH" -gt 12 ] 2>/dev/null; then
            echo -e "  ${YELLOW}[WARN]${NC} $FILE: Invalid month in timestamp '$ts'"
            echo -e "         Expected: YYYYMMDD-HHMMSS (month 01-12)"
            WARNINGS=$((WARNINGS + 1))
        elif [ "$DAY" -lt 1 ] || [ "$DAY" -gt 31 ] 2>/dev/null; then
            echo -e "  ${YELLOW}[WARN]${NC} $FILE: Invalid day in timestamp '$ts'"
            echo -e "         Expected: YYYYMMDD-HHMMSS (day 01-31)"
            WARNINGS=$((WARNINGS + 1))
        elif [ "$HOUR" -gt 23 ] 2>/dev/null; then
            echo -e "  ${YELLOW}[WARN]${NC} $FILE: Invalid hour in timestamp '$ts'"
            echo -e "         Expected: YYYYMMDD-HHMMSS (hour 00-23)"
            WARNINGS=$((WARNINGS + 1))
        elif [ "$MIN" -gt 59 ] || [ "$SEC" -gt 59 ] 2>/dev/null; then
            echo -e "  ${YELLOW}[WARN]${NC} $FILE: Invalid minute/second in timestamp '$ts'"
            echo -e "         Expected: YYYYMMDD-HHMMSS (min/sec 00-59)"
            WARNINGS=$((WARNINGS + 1))
        fi
    done
done

echo -e "  ${GREEN}[PASS]${NC} Timestamp format check complete"
echo ""

# ============================================
# Check 5: Help.md Completeness (BLOCKING)
# ============================================
# This check BLOCKS commits when help.md is missing documentation for commands/skills
# Note: Check 3 already verifies all commands/skills are mentioned in help.md
# This check was moved from an exact-match comparison to completeness-only because
# some plugins maintain custom help content that doesn't match auto-generated output

# Check if any NEW command/skill files are being added (not just modified)
STAGED_NEW_COMMANDS=$(git diff --cached --name-only --diff-filter=A | grep -E '(commands|skills)/.*\.md$' || true)

if [ -n "$STAGED_NEW_COMMANDS" ]; then
    echo "Checking help.md completeness for new commands/skills (blocking)..."

    # For each new command/skill, verify it's mentioned in help.md
    NEW_FILE_ERRORS=0
    for new_file in $STAGED_NEW_COMMANDS; do
        # Extract plugin name from path (plugins/PLUGIN_NAME/commands/...)
        plugin_name=$(echo "$new_file" | sed -n 's|plugins/\([^/]*\)/.*|\1|p')
        cmd_name=$(basename "$new_file" .md)
        help_file="plugins/$plugin_name/skills/help/SKILL.md"

        # Skip if this is help.md itself
        if [ "$cmd_name" = "help" ]; then
            continue
        fi

        # Check if the command/skill is documented in help.md
        if [ -f "$help_file" ]; then
            if ! grep -q "/$cmd_name" "$help_file" 2>/dev/null; then
                echo -e "  ${RED}[FAIL]${NC} New command/skill /$cmd_name not documented in $help_file"
                NEW_FILE_ERRORS=$((NEW_FILE_ERRORS + 1))
            fi
        fi
    done

    if [ $NEW_FILE_ERRORS -gt 0 ]; then
        echo ""
        echo -e "  ${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "  ${RED}Help.md Missing New Commands${NC}"
        echo -e "  ${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo ""
        echo "  When adding new commands/skills, update the help.md file."
        echo ""
        echo "  To fix this, run one of the following:"
        echo ""
        echo "    Option 1: Regenerate help.md files automatically"
        echo "      python scripts/generate-help.py --all"
        echo ""
        echo "    Option 2: Use Claude Code (recommended)"
        echo "      /validate-plugin --fix"
        echo ""
        echo "  After fixing, stage the updated help.md files and commit again."
        echo -e "  ${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        ERRORS=$((ERRORS + $NEW_FILE_ERRORS))
    else
        echo -e "  ${GREEN}[PASS]${NC} All new commands/skills documented in help.md"
    fi
    echo ""
else
    # No new command/skill files, but check if help.md sync is recommended
    STAGED_COMMAND_SKILLS=$(echo "$STAGED_FILES" | grep -E '(commands|skills)/.*\.md$' || true)
    if [ -n "$STAGED_COMMAND_SKILLS" ]; then
        echo "Checking help.md sync (informational)..."
        if command -v python &> /dev/null && [ -f "scripts/generate-help.py" ]; then
            if python scripts/generate-help.py --all --check 2>/dev/null; then
                echo -e "  ${GREEN}[PASS]${NC} help.md files match auto-generated format"
            else
                echo -e "  ${YELLOW}[INFO]${NC} help.md files differ from auto-generated format"
                echo -e "         This is OK if you maintain custom help content."
                echo -e "         Run 'python scripts/generate-help.py --all' to regenerate if needed."
            fi
        fi
        echo ""
    fi
fi

# ============================================
# Summary
# ============================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Validation Summary"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Errors: $ERRORS${NC}"
    echo -e "${YELLOW}Warnings: $WARNINGS${NC}"
    echo ""
    echo -e "${RED}Commit blocked. Please fix the errors above.${NC}"
    echo ""
    echo "Tips:"
    echo "  - Every command/skill needs frontmatter with 'description'"
    echo "  - Do NOT include 'name' field (filename determines command name)"
    echo "  - Ensure all code blocks are closed with \`\`\`"
    echo "  - help.md MUST be synced when changing commands/skills"
    echo "    Fix with: python scripts/generate-help.py --all"
    echo "  - Use YYYYMMDD-HHMMSS format for timestamps (e.g., 20260114-143052)"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
else
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${GREEN}Errors: 0${NC}"
        echo -e "${YELLOW}Warnings: $WARNINGS${NC}"
        echo ""
        echo -e "${GREEN}Validation passed with warnings.${NC}"
    else
        echo -e "${GREEN}All checks passed!${NC}"
    fi
    exit 0
fi
