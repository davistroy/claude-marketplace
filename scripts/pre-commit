#!/bin/bash
#
# Pre-commit hook for claude-marketplace
# Validates staged markdown files in the plugins directory
#
# Installation:
#   cp scripts/pre-commit .git/hooks/
#   chmod +x .git/hooks/pre-commit
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running plugin validation pre-commit hook..."
echo ""

# Get list of staged .md files in plugins/
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^plugins/.*\.md$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No plugin markdown files staged. Skipping validation.${NC}"
    exit 0
fi

echo "Validating staged plugin files:"
echo "$STAGED_FILES" | while read -r file; do
    echo "  - $file"
done
echo ""

# Track errors
ERRORS=0
WARNINGS=0

# Validate each staged file
for FILE in $STAGED_FILES; do
    if [ ! -f "$FILE" ]; then
        continue
    fi

    echo "Checking: $FILE"

    # Check for frontmatter delimiters
    FIRST_LINE=$(head -n 1 "$FILE")
    if [ "$FIRST_LINE" != "---" ]; then
        echo -e "  ${RED}[FAIL]${NC} Missing frontmatter (must start with ---)"
        ERRORS=$((ERRORS + 1))
        continue
    fi

    # Extract frontmatter (between first two ---)
    FRONTMATTER=$(sed -n '2,/^---$/p' "$FILE" | head -n -1)

    if [ -z "$FRONTMATTER" ]; then
        echo -e "  ${RED}[FAIL]${NC} Empty or malformed frontmatter"
        ERRORS=$((ERRORS + 1))
        continue
    fi

    # Check for required 'description' field
    if ! echo "$FRONTMATTER" | grep -q "^description:"; then
        echo -e "  ${RED}[FAIL]${NC} Missing required 'description' field in frontmatter"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "  ${GREEN}[PASS]${NC} description field present"
    fi

    # Check for forbidden 'name' field (per CLAUDE.md)
    if echo "$FRONTMATTER" | grep -q "^name:"; then
        echo -e "  ${RED}[FAIL]${NC} Forbidden 'name' field found (filename determines command name)"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "  ${GREEN}[PASS]${NC} No forbidden 'name' field"
    fi

    # Check for basic YAML syntax (colon after field name)
    if echo "$FRONTMATTER" | grep -E "^[a-z]+" | grep -v ":"; then
        echo -e "  ${YELLOW}[WARN]${NC} Possible YAML syntax issue (missing colon?)"
        WARNINGS=$((WARNINGS + 1))
    fi

    # Check for unclosed code blocks
    BACKTICK_COUNT=$(grep -c '```' "$FILE" || true)
    if [ $((BACKTICK_COUNT % 2)) -ne 0 ]; then
        echo -e "  ${RED}[FAIL]${NC} Unclosed code block (odd number of \`\`\`)"
        ERRORS=$((ERRORS + 1))
    fi

    echo ""
done

# Summary
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Validation Summary"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Errors: $ERRORS${NC}"
    echo -e "${YELLOW}Warnings: $WARNINGS${NC}"
    echo ""
    echo -e "${RED}Commit blocked. Please fix the errors above.${NC}"
    echo ""
    echo "Tips:"
    echo "  - Every command/skill needs frontmatter with 'description'"
    echo "  - Do NOT include 'name' field (filename determines command name)"
    echo "  - Ensure all code blocks are closed with \`\`\`"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
else
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${GREEN}Errors: 0${NC}"
        echo -e "${YELLOW}Warnings: $WARNINGS${NC}"
        echo ""
        echo -e "${GREEN}Validation passed with warnings.${NC}"
    else
        echo -e "${GREEN}All checks passed!${NC}"
    fi
    exit 0
fi
