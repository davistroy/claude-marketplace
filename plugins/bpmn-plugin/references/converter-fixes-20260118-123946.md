# BPMN to Draw.io Converter Fixes

**Date:** 2026-01-18
**Test File:** `examples/comprehensive_edge_case_test.bpmn`

## Overview

This document describes fixes made to the bpmn2drawio converter to handle edge cases discovered during comprehensive testing with a multi-pool, multi-lane BPMN diagram containing nested subprocesses and boundary events.

---

## Fix 1: Lane-to-Pool Assignment

### Problem
All lanes were being assigned to the first pool with a `processRef`, regardless of which process actually contained the laneSet. This caused lanes from different pools to be incorrectly grouped.

### Root Cause
In `_parse_collaboration`, lanes were associated with pools without tracking which process each lane belonged to.

### Solution
**Files Modified:** `parser.py`, `models.py`

1. Added `process_id` field to `Lane` dataclass in `models.py`:
```python
@dataclass
class Lane:
    id: str
    name: Optional[str] = None
    parent_pool_id: str = ""
    process_id: Optional[str] = None  # NEW: ID of the process containing this lane
    # ...
```

2. Modified `_parse_process_contents` to pass `process_id` to `_parse_lane_set`
3. Modified `_parse_lane_set` to pass `process_id` to `_parse_lane`
4. Modified `_parse_lane` to accept and store `process_id`
5. Modified `_parse_collaboration` to match lanes to pools based on `lane.process_id == pool.process_ref`

---

## Fix 2: Lane Y Positioning Per Pool

### Problem
Lane Y positions were cumulative across all pools (e.g., 0, 140, 280, 900, 1040, 1180) instead of starting at Y=0 within each pool.

### Root Cause
The `_organize_by_lanes` method in `position_resolver.py` used a single `current_y` variable that incremented globally across all lanes regardless of pool boundaries.

### Solution
**File Modified:** `position_resolver.py`

Refactored `_organize_by_lanes` to:
1. Group lanes by their `parent_pool_id`
2. Position each pool's lanes starting at Y=0 (relative to pool)
3. Track per-pool heights in a `pool_heights` dictionary
4. Stack pools vertically with appropriate gaps

```python
# Group lanes by their parent pool
pool_lanes: Dict[str, List[Lane]] = {}
for lane in model.lanes:
    pool_id = lane.parent_pool_id or "default"
    if pool_id not in pool_lanes:
        pool_lanes[pool_id] = []
    pool_lanes[pool_id].append(lane)

# Position lanes within each pool, starting at Y=0 relative to pool
for pool_id, lanes_in_pool in pool_lanes.items():
    current_y = 0.0  # Start at 0 for each pool
    for lane in lanes_in_pool:
        lane_y_positions[lane.id] = current_y
        current_y += lane_heights[lane.id]
    pool_heights[pool_id] = current_y
```

---

## Fix 3: Subprocess Parsing Order

### Problem
Subprocesses were not getting the `_is_subprocess` property set, causing them to be rendered as regular tasks instead of collapsible containers.

### Root Cause
In `_parse_process_contents`, the generic element check (`if tag in ALL_ELEMENT_TYPES`) was executed before the subprocess-specific check. Since `subProcess` is in `TASK_TYPES` (which is part of `ALL_ELEMENT_TYPES`), subprocesses were parsed by the generic handler.

### Solution
**File Modified:** `parser.py`

Moved the subprocess check BEFORE the generic element check:

```python
# Handle subProcess FIRST (before generic ALL_ELEMENT_TYPES check)
# because subProcess is in TASK_TYPES but needs special handling
if tag == "subProcess":
    element = self._parse_element(child, tag)
    element.properties["_is_subprocess"] = True
    model.elements.append(element)
    self._parse_subprocess_contents(child, model, element.id, process_id)

elif tag in ALL_ELEMENT_TYPES:
    # Generic element handling...
```

---

## Fix 4: Nested Subprocess Parsing

### Problem
Nested subprocesses (subprocesses inside subprocesses) were also not getting the `_is_subprocess` property set.

### Root Cause
Same issue as Fix 3, but in `_parse_subprocess_contents` method.

### Solution
**File Modified:** `parser.py`

Applied the same fix to `_parse_subprocess_contents` - moved the nested subprocess check before the generic element check.

---

## Fix 5: Boundary Event Positioning and Parenting

### Problem
Boundary events had:
- `parent="1"` (root) instead of being children of their attached subprocess
- Absolute coordinates instead of coordinates relative to their parent
- Wrong style (rectangle instead of ellipse)

### Root Cause
The `_position_boundary_events` method only set coordinates but didn't set `parent_id` for boundary events.

### Solution
**File Modified:** `position_resolver.py`

Enhanced `_position_boundary_events` to:
1. Set `element.parent_id` to the attached element (subprocess/task)
2. Calculate coordinates relative to the parent element
3. Space multiple boundary events along the bottom edge

```python
if attached_id and attached_id in elem_lookup:
    attached = elem_lookup[attached_id]

    # Set parent_id to the attached element
    element.parent_id = attached_id

    # Position on the bottom edge, spaced apart (relative coordinates)
    spacing = 50
    x_offset = 20 + (boundary_index * spacing)
    element.x = x_offset
    element.y = attached_height - (event_height / 2)
```

---

## Fix 6: Boundary Event Parent Resolution in Generator

### Problem
Even after setting `parent_id` in the position resolver, boundary events still got `parent="1"` in the output because the generator didn't look up subprocess cell IDs.

### Root Cause
The `_create_vertex` method's parent resolution logic checked lane and pool cell IDs but not subprocess cell IDs when resolving `element.parent_id`.

### Solution
**File Modified:** `generator.py`

Added subprocess cell ID lookup in parent resolution:

```python
elif element.parent_id:
    # Check if parent is a subprocess (for boundary events)
    if element.parent_id in self._subprocess_cell_ids:
        parent_cell_id = self._subprocess_cell_ids[element.parent_id]
    # Check if parent is a lane
    elif element.parent_id in self._lane_cell_ids:
        parent_cell_id = self._lane_cell_ids[element.parent_id]
    # ...
```

---

## Fix 7: Missing Styles in Theme

### Problem
Boundary events and subprocesses were getting the default task style (rounded rectangle) instead of their proper BPMN styles.

### Root Cause
The `style_for` method in `BPMNTheme` class didn't include entries for `boundaryEvent`, `subProcess`, or `callActivity`.

### Solution
**File Modified:** `themes.py`

Added missing style entries:

```python
styles = {
    # ... existing styles ...
    "boundaryEvent": f"ellipse;whiteSpace=wrap;html=1;aspect=fixed;fillColor={self.intermediate_event_fill};strokeColor={self.intermediate_event_stroke};strokeWidth=2;perimeter=ellipsePerimeter;",
    "subProcess": f"rounded=1;whiteSpace=wrap;html=1;container=1;collapsible=1;childLayout=stackLayout;horizontalStack=0;resizeParent=1;resizeLast=0;dropTarget=1;fontStyle=1;swimlane=0;startSize=26;fillColor={self.task_fill};strokeColor={self.task_stroke};",
    "callActivity": f"rounded=1;whiteSpace=wrap;html=1;fillColor={self.task_fill};strokeColor={self.task_stroke};arcSize=10;strokeWidth=3;",
    # ...
}
```

---

## Fix 8: Nested Subprocess Parent Resolution

### Problem
Nested subprocesses had `parent="1"` instead of being children of their containing subprocess.

### Root Cause
The `_create_subprocess_container` method checked `element.properties.get("subprocess_id")` but the actual attribute is `element.subprocess_id` (set directly on the element, not in properties).

### Solution
**File Modified:** `generator.py`

Changed to check both attribute and property:

```python
subprocess_id = element.subprocess_id or element.properties.get("subprocess_id")
if subprocess_id:
    if subprocess_id in self._subprocess_cell_ids:
        parent_cell_id = self._subprocess_cell_ids[subprocess_id]
```

---

## Verification

After all fixes, the converter correctly handles:

| Feature | Before | After |
|---------|--------|-------|
| Elements converted | 46 | 57 |
| Flows converted | 51 | 62 |
| Lane Y positions | Cumulative (0, 140, 280, 900...) | Per-pool (0, 140, 0, 140...) |
| Subprocess style | Rectangle | Collapsible container |
| Boundary event parent | Root (1) | Attached subprocess |
| Boundary event style | Rectangle | Ellipse |
| Nested subprocess parent | Root (1) | Parent subprocess |

---

## Files Changed

| File | Changes |
|------|---------|
| `src/bpmn2drawio/parser.py` | Subprocess parsing order, lane process_id tracking |
| `src/bpmn2drawio/models.py` | Added `process_id` to Lane dataclass |
| `src/bpmn2drawio/position_resolver.py` | Per-pool lane positioning, boundary event parenting |
| `src/bpmn2drawio/generator.py` | Parent resolution for subprocesses and boundary events |
| `src/bpmn2drawio/themes.py` | Added missing element styles |
